<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/AuthSite.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE LambdaCase #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# OPTIONS_GHC -fno-warn-orphans #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{- |
<a name="line-7"></a>Description : Subsite for email-and-passphrase authentication
<a name="line-8"></a>License     : AGPL-3
<a name="line-9"></a>Maintainer  : dev@lists.snowdrift.coop
<a name="line-10"></a>
<a name="line-11"></a>Subsite for email-and-passphrase authentication.
<a name="line-12"></a>
<a name="line-13"></a>Quickstart:
<a name="line-14"></a>
<a name="line-15"></a>1. Add 'AuthSite' as a subsite to your routes somewhere.
<a name="line-16"></a>2. Mappend 'migrateAuth' to your site's 'Migration' when running migrations.
<a name="line-17"></a>3. Have your site datatype instantiate 'AuthMaster' (this is the hard part).
<a name="line-18"></a>
<a name="line-19"></a>This module is not yet fit for general consumption. It is tightly coupled
<a name="line-20"></a>to some Snowdrift types and functions.
<a name="line-21"></a>-}</span>
<a name="line-22"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>AuthSite</span>
<a name="line-23"></a>    <span class='hs-layout'>(</span> <span class='hs-comment'>-- * Subsite interface</span>
<a name="line-24"></a>      <span class='hs-comment'>-- ** Integration with your site</span>
<a name="line-25"></a>      <span class='hs-conid'>AuthSite</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-26"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>migrateAuth</span>
<a name="line-27"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>AuthMaster</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-28"></a>      <span class='hs-comment'>-- ** Routes</span>
<a name="line-29"></a>      <span class='hs-comment'>-- | Haddock seems to dump the entire 'Route' definition, even</span>
<a name="line-30"></a>      <span class='hs-comment'>-- though the only interesting thing here is the AuthSite instance</span>
<a name="line-31"></a>      <span class='hs-comment'>-- with LoginR, LogoutR, CreateAccountR, VerifyAccountR, and</span>
<a name="line-32"></a>      <span class='hs-comment'>-- ResetPassphraseR.</span>
<a name="line-33"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Route</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-34"></a>      <span class='hs-comment'>-- ** Querying auth status</span>
<a name="line-35"></a>      <span class='hs-comment'>-- | Duplicating the "Yesod.Auth" interface</span>
<a name="line-36"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>maybeAuth</span>
<a name="line-37"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>requireAuth</span>
<a name="line-38"></a>      <span class='hs-comment'>-- * Helpers for instantiating 'AuthMaster'</span>
<a name="line-39"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>credentialsForm</span>
<a name="line-40"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Credentials</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-41"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>AuthEmail</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-42"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>ClearPassphrase</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-43"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>AuthMailMessage</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-44"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>AuthToken</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-45"></a>      <span class='hs-comment'>-- * Internals</span>
<a name="line-46"></a>      <span class='hs-comment'>-- | These are exported for use in tests. You probably don't want to</span>
<a name="line-47"></a>      <span class='hs-comment'>-- use them yourself.</span>
<a name="line-48"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>AuthUser</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-49"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>provisional</span>
<a name="line-50"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>logout</span>
<a name="line-51"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>priviligedProvisionalUser</span>
<a name="line-52"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>privilegedCreateUser</span>
<a name="line-53"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>priviligedLogin</span>
<a name="line-54"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>VerifiedUser</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-55"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Verification</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-56"></a>      <span class='hs-comment'>-- ** @persistent@-generated types</span>
<a name="line-57"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>ProvisionalUser</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-58"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-59"></a>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span>
<a name="line-61"></a>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Error</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Lens</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Crypto</span><span class='hs-varop'>.</span><span class='hs-conid'>Nonce</span> <span class='hs-layout'>(</span><span class='hs-conid'>Generator</span><span class='hs-layout'>,</span> <span class='hs-varid'>nonce128urlT</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Crypto</span><span class='hs-varop'>.</span><span class='hs-conid'>PasswordStore</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Encoding</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Time</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Typeable</span>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>Persist</span><span class='hs-varop'>.</span><span class='hs-conid'>Sql</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Yesod</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Crypto</span><span class='hs-varop'>.</span><span class='hs-conid'>Nonce</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Nonce</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-comment'>-- Used to create a single, applicationd-wide nonce token. I'm doing this</span>
<a name="line-78"></a><span class='hs-comment'>-- out of expediency; Yesod.Auth uses it and nobody seems to care. But I</span>
<a name="line-79"></a><span class='hs-comment'>-- don't like it.</span>
<a name="line-80"></a><span class='hs-comment'>-- https://github.com/yesodweb/yesod/issues/1245</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafePerformIO</span><span class='hs-layout'>)</span>
<a name="line-82"></a>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>AuthSiteTypes</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-comment'>-- Need this until we switch back to using messages instead of</span>
<a name="line-86"></a><span class='hs-comment'>-- Yesod-specific "alerts".</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Alerts</span>
<a name="line-88"></a>
<a name="line-89"></a><span class='hs-comment'>-- Still need this until we take the time to put AuthUser into the</span>
<a name="line-90"></a><span class='hs-comment'>-- AuthMaster class.</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Model</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="AuthUser"></a><span class='hs-comment'>-- | This is a cheapo synonym. Eventually AuthUser should be part of the</span>
<a name="line-94"></a><a name="AuthUser"></a><span class='hs-comment'>-- 'AuthMaster' interface, for this module to be usable outside of</span>
<a name="line-95"></a><a name="AuthUser"></a><span class='hs-comment'>-- Snowdrift.</span>
<a name="line-96"></a><a name="AuthUser"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>AuthUser</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Entity</span> <span class='hs-conid'>User</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="AuthMaster"></a><span class='hs-comment'>-- | Any site that uses this subsite needs to instantiate this class.</span>
<a name="line-99"></a><a name="AuthMaster"></a><span class='hs-keyword'>class</span> <span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>master</span> <span class='hs-keyword'>where</span>
<a name="line-100"></a>
<a name="line-101"></a>    <span class='hs-comment'>-- | Where to go after login</span>
<a name="line-102"></a>    <span class='hs-varid'>postLoginRoute</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Route</span> <span class='hs-varid'>master</span>
<a name="line-103"></a>
<a name="line-104"></a>    <span class='hs-comment'>-- | Where to go after logout</span>
<a name="line-105"></a>    <span class='hs-varid'>postLogoutRoute</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Route</span> <span class='hs-varid'>master</span>
<a name="line-106"></a>
<a name="line-107"></a>    <span class='hs-comment'>-- | What to show on the login page. This page should have a form that posts</span>
<a name="line-108"></a>    <span class='hs-comment'>-- 'Credentials' to 'Route LoginR'. See 'AuthHarness' in the tests for a</span>
<a name="line-109"></a>    <span class='hs-comment'>-- simplistic example.</span>
<a name="line-110"></a>    <span class='hs-varid'>loginHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>TypedContent</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-comment'>-- | What to show on the create-account page. This page should post</span>
<a name="line-113"></a>    <span class='hs-comment'>-- 'Credentials' to 'AuthSiteTypes.CreateAccountR'.</span>
<a name="line-114"></a>    <span class='hs-varid'>createAccountHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>TypedContent</span>
<a name="line-115"></a>
<a name="line-116"></a>    <span class='hs-comment'>-- | What to show on the reset-passphrase page. This page should post</span>
<a name="line-117"></a>    <span class='hs-comment'>-- 'Credentials' to 'ResetPassphraseR'</span>
<a name="line-118"></a>    <span class='hs-varid'>resetPassphraseHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>TypedContent</span>
<a name="line-119"></a>
<a name="line-120"></a>    <span class='hs-comment'>-- | What to show on the verify-account page. This page should post</span>
<a name="line-121"></a>    <span class='hs-comment'>-- 'Text' (the token) to 'VerifyAccountR'</span>
<a name="line-122"></a>    <span class='hs-varid'>verifyAccountHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>TypedContent</span>
<a name="line-123"></a>
<a name="line-124"></a>    <span class='hs-comment'>-- | This module sends emails, in case that wasn't obvious.</span>
<a name="line-125"></a>    <span class='hs-comment'>-- "Network.Mail.Mime" or "Network.Mail.Mime.SES" have good options for</span>
<a name="line-126"></a>    <span class='hs-comment'>-- this method.</span>
<a name="line-127"></a>    <span class='hs-varid'>sendAuthEmail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AuthEmail</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AuthMailMessage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-128"></a>
<a name="line-129"></a><a name="AuthToken"></a><span class='hs-comment'>-- | A token used to confirm an email address.</span>
<a name="line-130"></a><a name="AuthToken"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>AuthToken</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AuthToken</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fromAuthToken</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="AuthMailMessage"></a><span class='hs-comment'>-- | The type of message you are expected to send.</span>
<a name="line-133"></a><a name="AuthMailMessage"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>AuthMailMessage</span>
<a name="line-134"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VerifyUserCreation</span> <span class='hs-conid'>AuthToken</span>
<a name="line-135"></a>        <span class='hs-comment'>-- ^ A user is signing up</span>
<a name="line-136"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VerifyPassReset</span> <span class='hs-conid'>AuthToken</span>
<a name="line-137"></a>        <span class='hs-comment'>-- ^ A user wants to reset their passphrase</span>
<a name="line-138"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BadUserCreation</span>
<a name="line-139"></a>        <span class='hs-comment'>-- ^ A user tried to sign up with an existing address</span>
<a name="line-140"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BadPassReset</span>
<a name="line-141"></a>        <span class='hs-comment'>-- ^ A user tried to reset with an address that doesn't exist</span>
<a name="line-142"></a>        <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="AuthEmail"></a><span class='hs-comment'>-- | Sanity-preserving type</span>
<a name="line-145"></a><a name="AuthEmail"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>AuthEmail</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AuthEmail</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fromAuth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="ClearPassphrase"></a><span class='hs-comment'>-- | Sanity-preserving type</span>
<a name="line-148"></a><a name="ClearPassphrase"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>ClearPassphrase</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClearPassphrase</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fromClear</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-149"></a>
<a name="line-150"></a><a name="PassphraseDigest"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>PassphraseDigest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PassphraseDigest</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-151"></a>
<a name="line-152"></a><a name="Credentials"></a><span class='hs-comment'>-- | The "email and passphrase" representing the main purpose of this</span>
<a name="line-153"></a><a name="Credentials"></a><span class='hs-comment'>-- module.</span>
<a name="line-154"></a><a name="Credentials"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Credentials</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Credentials</span>
<a name="line-155"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>credsIdent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AuthEmail</span>
<a name="line-156"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>credsPass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClearPassphrase</span>
<a name="line-157"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>)</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="VerifiedUser"></a><span class='hs-comment'>-- | Internal</span>
<a name="line-160"></a><a name="VerifiedUser"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>VerifiedUser</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VerifiedUser</span>
<a name="line-161"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>verifiedEmail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span>
<a name="line-162"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>verifiedDigest</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span>
<a name="line-163"></a>        <span class='hs-layout'>}</span>
<a name="line-164"></a>
<a name="line-165"></a><a name="Verification"></a><span class='hs-comment'>-- | Internal</span>
<a name="line-166"></a><a name="Verification"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Verification</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Verification</span>
<a name="line-167"></a>        <span class='hs-layout'>{</span> <span class='hs-varid'>verifyEmail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AuthEmail</span>
<a name="line-168"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>verifyToken</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AuthToken</span>
<a name="line-169"></a>        <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="CachedAuth"></a><span class='hs-comment'>-- | Used with Yesod caching feature</span>
<a name="line-172"></a><a name="CachedAuth"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>CachedAuth</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CachedAuth</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unCachedAuth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Typeable</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="instance%20YesodSubDispatch%20AuthSite%20(HandlerT%20master%20IO)"></a><span class='hs-keyword'>instance</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span>
<a name="line-175"></a>         <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>master</span>
<a name="line-176"></a>         <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span>
<a name="line-177"></a>         <span class='hs-layout'>,</span><span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>master</span> <span class='hs-conid'>FormMessage</span>
<a name="line-178"></a>         <span class='hs-layout'>,</span><span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>master</span><span class='hs-layout'>)</span>
<a name="line-179"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>YesodSubDispatch</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-180"></a>    <span class='hs-varid'>yesodSubDispatch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>mkYesodSubDispatch</span> <span class='hs-varid'>resourcesAuthSite</span><span class='hs-layout'>)</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="maybeAuth"></a><span class='hs-comment'>-- | If the user is authenticated, get the corresponding Entity.</span>
<a name="line-183"></a><span class='hs-definition'>maybeAuth</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>m</span>
<a name="line-184"></a>             <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span><span class='hs-layout'>)</span>
<a name="line-185"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>AuthUser</span><span class='hs-layout'>)</span>
<a name="line-186"></a><span class='hs-definition'>maybeAuth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-187"></a>    <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupSession</span> <span class='hs-varid'>authSessionKey</span>
<a name="line-188"></a>    <span class='hs-varid'>uid</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromPathPiece</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-189"></a>    <span class='hs-varid'>u</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>unCachedAuth</span> <span class='hs-layout'>(</span><span class='hs-varid'>cached</span> <span class='hs-layout'>(</span><span class='hs-varid'>runDB</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>CachedAuth</span> <span class='hs-layout'>(</span><span class='hs-varid'>get</span> <span class='hs-varid'>uid</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-190"></a>    <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>Entity</span> <span class='hs-varid'>uid</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="requireAuth"></a><span class='hs-comment'>-- | If the user is /not/ authenticated, this will cause a redirect to your</span>
<a name="line-193"></a><span class='hs-comment'>-- site's 'authRoute' or simply return 'notAuthenticated'.</span>
<a name="line-194"></a><span class='hs-comment'>--</span>
<a name="line-195"></a><span class='hs-comment'>-- Note that "Yesod.Auth" is smarter about not redirecting during an API</span>
<a name="line-196"></a><span class='hs-comment'>-- request, but we don't support that yet.</span>
<a name="line-197"></a><span class='hs-definition'>requireAuth</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>m</span>
<a name="line-198"></a>               <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>m</span>
<a name="line-199"></a>               <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span><span class='hs-layout'>)</span>
<a name="line-200"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>AuthUser</span>
<a name="line-201"></a><span class='hs-definition'>requireAuth</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-varid'>noAuth</span> <span class='hs-varid'>pure</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>maybeAuth</span>
<a name="line-202"></a>  <span class='hs-keyword'>where</span>
<a name="line-203"></a>    <span class='hs-varid'>noAuth</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-204"></a>        <span class='hs-varid'>setUltDestCurrent</span>
<a name="line-205"></a>        <span class='hs-varid'>maybe</span> <span class='hs-varid'>notAuthenticated</span> <span class='hs-varid'>redirect</span> <span class='hs-varop'>.</span> <span class='hs-varid'>authRoute</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>getYesod</span>
<a name="line-206"></a>
<a name="line-207"></a><a name="credentialsForm"></a><span class='hs-comment'>-- | A decent default form for 'Credentials'.</span>
<a name="line-208"></a><span class='hs-definition'>credentialsForm</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RenderMessage</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerSite</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadHandler</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-209"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AForm</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Credentials</span>
<a name="line-210"></a><span class='hs-definition'>credentialsForm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Credentials</span>
<a name="line-211"></a>    <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>AuthEmail</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>areq</span> <span class='hs-varid'>textField</span> <span class='hs-str'>"Email"</span><span class='hs-layout'>{</span><span class='hs-varid'>fsAttrs</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>emailAttrs</span><span class='hs-layout'>}</span>  <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-212"></a>    <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ClearPassphrase</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>areq</span> <span class='hs-varid'>passwordField</span> <span class='hs-str'>"Passphrase"</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-213"></a>  <span class='hs-keyword'>where</span>
<a name="line-214"></a>    <span class='hs-varid'>emailAttrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-str'>"autofocus"</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"autocomplete"</span><span class='hs-layout'>,</span><span class='hs-str'>"email"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-215"></a>
<a name="line-216"></a><a name="authSessionKey"></a><span class='hs-definition'>authSessionKey</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span>
<a name="line-217"></a><span class='hs-definition'>authSessionKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"_AUTHID"</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="pbkdf1Strength"></a><span class='hs-comment'>-- Per the docs, this number should increase by 1 every two years, starting</span>
<a name="line-220"></a><span class='hs-comment'>-- at 17 in 2014. Thus, 17 + (now^.year - 2014) / 2. We could even TH that</span>
<a name="line-221"></a><span class='hs-comment'>-- bizniss.</span>
<a name="line-222"></a><span class='hs-comment'>--</span>
<a name="line-223"></a><span class='hs-comment'>-- Ok, I TH'd it. Will I regret it? Yes. Leaving it commented for</span>
<a name="line-224"></a><span class='hs-comment'>-- now.</span>
<a name="line-225"></a><span class='hs-definition'>pbkdf1Strength</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-226"></a><span class='hs-definition'>pbkdf1Strength</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>18</span>
<a name="line-227"></a><span class='hs-comment'>-- pbkdf1Strength = 17 + (yr - 2014) `div` 2</span>
<a name="line-228"></a><span class='hs-comment'>--   where yr = $(litE =&lt;&lt; runIO (fmap ( IntegerL</span>
<a name="line-229"></a><span class='hs-comment'>--                                     . (\(a,_,_) -&gt; a)</span>
<a name="line-230"></a><span class='hs-comment'>--                                     . toGregorian</span>
<a name="line-231"></a><span class='hs-comment'>--                                     . utctDay)</span>
<a name="line-232"></a><span class='hs-comment'>--                                     getCurrentTime))</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="tokenGenerator"></a><span class='hs-comment'>-- | Yesod.Auth uses this, and it's apparently ok.</span>
<a name="line-235"></a><span class='hs-comment'>-- https://github.com/yesodweb/yesod/issues/1245</span>
<a name="line-236"></a><span class='hs-definition'>tokenGenerator</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Generator</span>
<a name="line-237"></a><span class='hs-definition'>tokenGenerator</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-conid'>Nonce</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span>
<a name="line-238"></a><span class='hs-comment'>{-# NOINLINE tokenGenerator #-}</span>
<a name="line-239"></a>
<a name="line-240"></a><a name="makeAuthPass"></a><span class='hs-comment'>-- | Our wrap over makePassword</span>
<a name="line-241"></a><span class='hs-definition'>makeAuthPass</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makePassword</span> <span class='hs-layout'>(</span><span class='hs-varid'>encodeUtf8</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varid'>pbkdf1Strength</span>
<a name="line-242"></a>
<a name="line-243"></a><a name="checkCredentials"></a><span class='hs-comment'>-- | Compare some Credentials to what's stored in the database.</span>
<a name="line-244"></a><span class='hs-definition'>checkCredentials</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Credentials</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>AuthUser</span><span class='hs-layout'>)</span>
<a name="line-245"></a><span class='hs-definition'>checkCredentials</span> <span class='hs-conid'>Credentials</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-246"></a>    <span class='hs-varid'>mu</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBy</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqueUsr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAuth</span> <span class='hs-varid'>credsIdent</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-247"></a>    <span class='hs-varid'>pure</span> <span class='hs-varop'>$</span> <span class='hs-varid'>verify</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>mu</span>
<a name="line-248"></a>  <span class='hs-keyword'>where</span>
<a name="line-249"></a>    <span class='hs-varid'>verify</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Entity</span> <span class='hs-varid'>uid</span> <span class='hs-varid'>u</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-250"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>verifyPassword</span> <span class='hs-layout'>(</span><span class='hs-varid'>encodeUtf8</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromClear</span> <span class='hs-varid'>credsPass</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-varop'>^.</span><span class='hs-varid'>userDigest</span><span class='hs-layout'>)</span>
<a name="line-251"></a>            <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>
<a name="line-252"></a>            <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="checkToken"></a><span class='hs-comment'>-- | Verify a token given by the user. This is *destructive*; a token can</span>
<a name="line-255"></a><span class='hs-comment'>-- only ever be checked once.</span>
<a name="line-256"></a><span class='hs-definition'>checkToken</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AuthToken</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>VerifiedUser</span><span class='hs-layout'>)</span>
<a name="line-257"></a><span class='hs-definition'>checkToken</span> <span class='hs-layout'>(</span><span class='hs-conid'>AuthToken</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runMaybeT</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-258"></a>    <span class='hs-conid'>Entity</span> <span class='hs-varid'>pid</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>ProvisionalUser</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getBy</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqueToken</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-259"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>justM</span> <span class='hs-layout'>(</span><span class='hs-varid'>delete</span> <span class='hs-varid'>pid</span><span class='hs-layout'>)</span>
<a name="line-260"></a>    <span class='hs-varid'>now</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>justM</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varid'>getCurrentTime</span><span class='hs-layout'>)</span>
<a name="line-261"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>addUTCTime</span> <span class='hs-varid'>twoHours</span> <span class='hs-varid'>provisionalUserCreationTime</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>now</span>
<a name="line-262"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>just</span> <span class='hs-layout'>(</span><span class='hs-conid'>VerifiedUser</span> <span class='hs-varid'>provisionalUserEmail</span> <span class='hs-varid'>provisionalUserDigest</span><span class='hs-layout'>)</span>
<a name="line-263"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>nothing</span>
<a name="line-264"></a>  <span class='hs-keyword'>where</span>
<a name="line-265"></a>    <span class='hs-varid'>twoHours</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span> <span class='hs-varop'>*</span> <span class='hs-num'>60</span> <span class='hs-varop'>*</span> <span class='hs-num'>60</span>
<a name="line-266"></a>    <span class='hs-varid'>justM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MaybeT</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>Just</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="provisional"></a><span class='hs-comment'>-- | Generate a provisional user</span>
<a name="line-269"></a><span class='hs-definition'>provisional</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Credentials</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Verification</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ProvisionalUser</span>
<a name="line-270"></a><span class='hs-definition'>provisional</span> <span class='hs-conid'>Credentials</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-conid'>Verification</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-271"></a>    <span class='hs-conid'>ProvisionalUser</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>email</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>passDigest</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>token</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>curtime</span>
<a name="line-272"></a>  <span class='hs-keyword'>where</span>
<a name="line-273"></a>    <span class='hs-varid'>email</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAuth</span> <span class='hs-varid'>credsIdent</span><span class='hs-layout'>)</span>
<a name="line-274"></a>    <span class='hs-varid'>passDigest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeAuthPass</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromClear</span> <span class='hs-varid'>credsPass</span><span class='hs-layout'>)</span>
<a name="line-275"></a>    <span class='hs-varid'>token</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAuthToken</span> <span class='hs-varid'>verifyToken</span><span class='hs-layout'>)</span>
<a name="line-276"></a>    <span class='hs-varid'>curtime</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="genVerificationToken"></a><span class='hs-definition'>genVerificationToken</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Credentials</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Verification</span>
<a name="line-279"></a><span class='hs-definition'>genVerificationToken</span> <span class='hs-conid'>Credentials</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-280"></a>    <span class='hs-conid'>Verification</span> <span class='hs-varid'>credsIdent</span> <span class='hs-varop'>.</span> <span class='hs-conid'>AuthToken</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>nonce128urlT</span> <span class='hs-varid'>tokenGenerator</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="privilegedCreateUser"></a><span class='hs-comment'>-- | Insert a new user into the database.</span>
<a name="line-283"></a><span class='hs-definition'>privilegedCreateUser</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>VerifiedUser</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-284"></a><span class='hs-definition'>privilegedCreateUser</span> <span class='hs-conid'>VerifiedUser</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-285"></a>    <span class='hs-varid'>insert_</span> <span class='hs-layout'>(</span><span class='hs-conid'>User</span> <span class='hs-varid'>verifiedEmail</span> <span class='hs-varid'>verifiedDigest</span><span class='hs-layout'>)</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="priviligedLogin"></a><span class='hs-comment'>-- | This privileged function must be used with care. It modifies the</span>
<a name="line-288"></a><span class='hs-comment'>-- user's session; it's the difference between being logged in and not!</span>
<a name="line-289"></a><span class='hs-definition'>priviligedLogin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AuthUser</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-290"></a><span class='hs-definition'>priviligedLogin</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSession</span> <span class='hs-varid'>authSessionKey</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toPathPiece</span> <span class='hs-varop'>.</span> <span class='hs-varid'>entityKey</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="priviligedProvisionalUser"></a><span class='hs-comment'>-- | Store a provisional user for later verification. Returns the token to</span>
<a name="line-293"></a><span class='hs-comment'>-- use for verification.</span>
<a name="line-294"></a><span class='hs-definition'>priviligedProvisionalUser</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span>
<a name="line-295"></a>                          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Credentials</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Verification</span>
<a name="line-296"></a><span class='hs-definition'>priviligedProvisionalUser</span> <span class='hs-varid'>creds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-297"></a>    <span class='hs-varid'>verf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>genVerificationToken</span> <span class='hs-varid'>creds</span><span class='hs-layout'>)</span>
<a name="line-298"></a>    <span class='hs-varid'>prov</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>provisional</span> <span class='hs-varid'>creds</span> <span class='hs-varid'>verf</span><span class='hs-layout'>)</span>
<a name="line-299"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>upsertOn</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqueProvisionalUser</span> <span class='hs-layout'>(</span><span class='hs-varid'>provisionalUserEmail</span> <span class='hs-varid'>prov</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prov</span> <span class='hs-conid'>[]</span>
<a name="line-300"></a>    <span class='hs-varid'>pure</span> <span class='hs-varid'>verf</span>
<a name="line-301"></a>  <span class='hs-keyword'>where</span>
<a name="line-302"></a>    <span class='hs-varid'>upsertOn</span> <span class='hs-varid'>uniqueKey</span> <span class='hs-varid'>record</span> <span class='hs-varid'>updates</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-303"></a>        <span class='hs-varid'>mExists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getBy</span> <span class='hs-varid'>uniqueKey</span>
<a name="line-304"></a>        <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mExists</span> <span class='hs-keyword'>of</span>
<a name="line-305"></a>            <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Entity</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-306"></a>              <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>updates</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>replace</span> <span class='hs-varid'>k</span> <span class='hs-varid'>record</span><span class='hs-layout'>)</span>
<a name="line-307"></a>              <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-308"></a>            <span class='hs-conid'>Nothing</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>insert</span> <span class='hs-varid'>record</span>
<a name="line-309"></a>        <span class='hs-conid'>Entity</span> <span class='hs-varid'>k</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>updateGet</span> <span class='hs-varid'>k</span> <span class='hs-varid'>updates</span>
<a name="line-310"></a>
<a name="line-311"></a><a name="logout"></a><span class='hs-comment'>-- | Log out by deleting the session var</span>
<a name="line-312"></a><span class='hs-definition'>logout</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-313"></a><span class='hs-definition'>logout</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deleteSession</span> <span class='hs-varid'>authSessionKey</span>
<a name="line-314"></a>
<a name="line-315"></a><a name="getLoginR"></a><span class='hs-definition'>getLoginR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>m</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>,</span> <span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-316"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>TypedContent</span>
<a name="line-317"></a><span class='hs-definition'>getLoginR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>loginHandler</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="postLoginR"></a><span class='hs-definition'>postLoginR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span>
<a name="line-320"></a>              <span class='hs-layout'>,</span><span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>master</span>
<a name="line-321"></a>              <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>master</span>
<a name="line-322"></a>              <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span>
<a name="line-323"></a>              <span class='hs-layout'>,</span><span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>master</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>)</span>
<a name="line-324"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>Html</span>
<a name="line-325"></a><span class='hs-definition'>postLoginR</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-326"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>res'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runFormPost</span> <span class='hs-layout'>(</span><span class='hs-varid'>renderDivs</span> <span class='hs-varid'>credentialsForm</span><span class='hs-layout'>)</span>
<a name="line-327"></a>    <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRouteToParent</span>
<a name="line-328"></a>    <span class='hs-varid'>formResult</span> <span class='hs-layout'>(</span><span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>runAuthResult</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&lt;=&lt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>runDB</span> <span class='hs-varop'>.</span> <span class='hs-varid'>checkCredentials</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-329"></a>               <span class='hs-varid'>res'</span>
<a name="line-330"></a>  <span class='hs-keyword'>where</span>
<a name="line-331"></a>    <span class='hs-varid'>runAuthResult</span> <span class='hs-varid'>parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span>
<a name="line-332"></a>        <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-333"></a>            <span class='hs-varid'>alertDanger</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>shamlet</span><span class='hs-keyglyph'>|</span><span class='hs-conid'>Bad</span> <span class='hs-varid'>credentials</span><span class='hs-conop'>:</span>  <span class='hs-varop'>&lt;</span><span class='hs-varid'>a</span> <span class='hs-varid'>href</span><span class='hs-keyglyph'>=</span><span class='hs-str'>"https://tree.taiga.io/project/snowdrift/us/392"</span><span class='hs-varop'>&gt;</span><span class='hs-conid'>See</span> <span class='hs-conid'>Taiga</span> <span class='hs-cpp'>#</span><span class='hs-num'>392</span><span class='hs-varop'>&lt;/</span><span class='hs-varid'>a</span><span class='hs-varop'>&gt;.|</span><span class='hs-keyglyph'>]</span>
<a name="line-334"></a>            <span class='hs-varid'>redirect</span> <span class='hs-layout'>(</span><span class='hs-varid'>parent</span> <span class='hs-conid'>LoginR</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-335"></a>        <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>u</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-336"></a>            <span class='hs-varid'>priviligedLogin</span> <span class='hs-varid'>u</span>
<a name="line-337"></a>            <span class='hs-varid'>alertInfo</span> <span class='hs-str'>"Welcome"</span>
<a name="line-338"></a>            <span class='hs-varid'>redirect</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>postLoginRoute</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getYesod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-339"></a>
<a name="line-340"></a><a name="formResult"></a><span class='hs-definition'>formResult</span> <span class='hs-varid'>success</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>case</span>
<a name="line-341"></a>    <span class='hs-conid'>FormSuccess</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>success</span> <span class='hs-varid'>x</span>
<a name="line-342"></a>    <span class='hs-conid'>FormFailure</span> <span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failure</span> <span class='hs-varid'>msgs</span>
<a name="line-343"></a>    <span class='hs-conid'>FormMissing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failure</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"No login data"</span><span class='hs-keyglyph'>]</span>
<a name="line-344"></a>  <span class='hs-keyword'>where</span>
<a name="line-345"></a>    <span class='hs-varid'>failure</span> <span class='hs-varid'>msgs</span> <span class='hs-keyglyph'>=</span>
<a name="line-346"></a>        <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>defaultLayout</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>whamlet</span><span class='hs-keyglyph'>|</span>
<a name="line-347"></a>            <span class='hs-varop'>&lt;</span><span class='hs-varid'>p</span><span class='hs-varop'>&gt;</span><span class='hs-conid'>Auth</span> <span class='hs-varid'>form</span> <span class='hs-varid'>failures</span> <span class='hs-varid'>are</span> <span class='hs-varid'>not</span> <span class='hs-varid'>handled</span> <span class='hs-varid'>yet</span><span class='hs-varop'>.</span>
<a name="line-348"></a>            <span class='hs-varop'>&lt;</span><span class='hs-varid'>p</span><span class='hs-varop'>&gt;</span><span class='hs-conid'>TBD</span><span class='hs-conop'>:</span> <span class='hs-varop'>&lt;</span><span class='hs-varid'>a</span> <span class='hs-varid'>href</span><span class='hs-keyglyph'>=</span><span class='hs-str'>"https://tree.taiga.io/project/snowdrift/us/392"</span><span class='hs-varop'>&gt;</span><span class='hs-conid'>See</span> <span class='hs-conid'>Taiga</span> <span class='hs-cpp'>#</span><span class='hs-num'>392</span><span class='hs-varop'>&lt;/</span><span class='hs-varid'>a</span><span class='hs-varop'>&gt;.</span>
<a name="line-349"></a>            <span class='hs-varop'>&lt;</span><span class='hs-varid'>p</span><span class='hs-varop'>&gt;</span><span class='hs-conid'>Errors</span><span class='hs-conop'>:</span> <span class='hs-cpp'>#</span><span class='hs-layout'>{</span><span class='hs-varid'>show</span> <span class='hs-varid'>msgs</span><span class='hs-layout'>}</span>
<a name="line-350"></a>            <span class='hs-keyglyph'>|</span><span class='hs-keyglyph'>]</span>
<a name="line-351"></a>
<a name="line-352"></a><span class='hs-comment'>-- ** Logout page</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="getLogoutR"></a><span class='hs-definition'>getLogoutR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span>
<a name="line-355"></a>              <span class='hs-layout'>,</span><span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>master</span><span class='hs-layout'>)</span>
<a name="line-356"></a>            <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>Html</span>
<a name="line-357"></a><span class='hs-definition'>getLogoutR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-358"></a>    <span class='hs-varid'>logout</span>
<a name="line-359"></a>    <span class='hs-varid'>alertInfo</span> <span class='hs-str'>"You are now logged out."</span>
<a name="line-360"></a>    <span class='hs-varid'>redirect</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>postLogoutRoute</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getYesod</span><span class='hs-layout'>)</span>
<a name="line-361"></a>
<a name="line-362"></a><span class='hs-comment'>-- ** CreateAccount page</span>
<a name="line-363"></a>
<a name="line-364"></a><a name="getCreateAccountR"></a><span class='hs-definition'>getCreateAccountR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>m</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>,</span> <span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-365"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>TypedContent</span>
<a name="line-366"></a><span class='hs-definition'>getCreateAccountR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>createAccountHandler</span>
<a name="line-367"></a>
<a name="line-368"></a><a name="postCreateAccountR"></a><span class='hs-definition'>postCreateAccountR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span>
<a name="line-369"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>master</span>
<a name="line-370"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span>
<a name="line-371"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>master</span>
<a name="line-372"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>master</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>)</span>
<a name="line-373"></a>                   <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>Html</span>
<a name="line-374"></a><span class='hs-definition'>postCreateAccountR</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-375"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runFormPost</span> <span class='hs-layout'>(</span><span class='hs-varid'>renderDivs</span> <span class='hs-varid'>credentialsForm</span><span class='hs-layout'>)</span>
<a name="line-376"></a>    <span class='hs-varid'>flip</span> <span class='hs-varid'>formResult</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Credentials</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-377"></a>        <span class='hs-varid'>mu</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-layout'>(</span><span class='hs-varid'>runDB</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBy</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqueUsr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAuth</span> <span class='hs-varid'>credsIdent</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-378"></a>        <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sendAuthEmail</span> <span class='hs-varid'>credsIdent</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>maybe</span>
<a name="line-379"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>VerifyUserCreation</span> <span class='hs-varop'>.</span> <span class='hs-varid'>verifyToken</span>
<a name="line-380"></a>                <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>runDB</span> <span class='hs-layout'>(</span><span class='hs-varid'>priviligedProvisionalUser</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-381"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-conid'>BadUserCreation</span><span class='hs-layout'>)</span>
<a name="line-382"></a>            <span class='hs-varid'>mu</span>
<a name="line-383"></a>        <span class='hs-varid'>redirectParent</span> <span class='hs-conid'>VerifyAccountR</span>
<a name="line-384"></a>        <span class='hs-layout'>)</span>
<a name="line-385"></a>
<a name="line-386"></a><a name="getResetPassphraseR"></a><span class='hs-comment'>-- | ResetPassphrase page</span>
<a name="line-387"></a><span class='hs-definition'>getResetPassphraseR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>m</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>,</span> <span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-388"></a>                     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>TypedContent</span>
<a name="line-389"></a><span class='hs-definition'>getResetPassphraseR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>resetPassphraseHandler</span>
<a name="line-390"></a>
<a name="line-391"></a><a name="postResetPassphraseR"></a><span class='hs-definition'>postResetPassphraseR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>master</span>
<a name="line-392"></a>                        <span class='hs-layout'>,</span><span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>master</span>
<a name="line-393"></a>                        <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>master</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span>
<a name="line-394"></a>                        <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>master</span>
<a name="line-395"></a>                        <span class='hs-layout'>,</span><span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>master</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>)</span>
<a name="line-396"></a>                     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>master</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>Html</span>
<a name="line-397"></a><span class='hs-definition'>postResetPassphraseR</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-398"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runFormPost</span> <span class='hs-layout'>(</span><span class='hs-varid'>renderDivs</span> <span class='hs-varid'>credentialsForm</span><span class='hs-layout'>)</span>
<a name="line-399"></a>    <span class='hs-varid'>flip</span> <span class='hs-varid'>formResult</span> <span class='hs-varid'>res</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>c</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Credentials</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-400"></a>        <span class='hs-varid'>mu</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-layout'>(</span><span class='hs-varid'>runDB</span> <span class='hs-layout'>(</span><span class='hs-varid'>getBy</span> <span class='hs-layout'>(</span><span class='hs-conid'>UniqueUsr</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromAuth</span> <span class='hs-varid'>credsIdent</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-401"></a>        <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sendAuthEmail</span> <span class='hs-varid'>credsIdent</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>maybe</span>
<a name="line-402"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>pure</span> <span class='hs-conid'>BadPassReset</span><span class='hs-layout'>)</span>
<a name="line-403"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-conid'>VerifyPassReset</span> <span class='hs-varop'>.</span> <span class='hs-varid'>verifyToken</span>
<a name="line-404"></a>                <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>runDB</span> <span class='hs-layout'>(</span><span class='hs-varid'>priviligedProvisionalUser</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-405"></a>            <span class='hs-varid'>mu</span>
<a name="line-406"></a>        <span class='hs-varid'>redirectParent</span> <span class='hs-conid'>VerifyAccountR</span>
<a name="line-407"></a>        <span class='hs-layout'>)</span>
<a name="line-408"></a>
<a name="line-409"></a><a name="getVerifyAccountR"></a><span class='hs-comment'>-- | VerifyAccount page</span>
<a name="line-410"></a><span class='hs-definition'>getVerifyAccountR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>m</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>,</span> <span class='hs-conid'>AuthMaster</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-411"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>TypedContent</span>
<a name="line-412"></a><span class='hs-definition'>getVerifyAccountR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>verifyAccountHandler</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="postVerifyAccountR"></a><span class='hs-comment'>-- | Handle an attempted verification.</span>
<a name="line-415"></a><span class='hs-comment'>--</span>
<a name="line-416"></a><span class='hs-comment'>-- Steps taken:</span>
<a name="line-417"></a><span class='hs-comment'>-- 1a get the form data</span>
<a name="line-418"></a><span class='hs-comment'>-- 2a get/delete the provisional user</span>
<a name="line-419"></a><span class='hs-comment'>-- 3a ensure that it isn't expired</span>
<a name="line-420"></a><span class='hs-comment'>-- 4a upsert the user</span>
<a name="line-421"></a><span class='hs-comment'>--</span>
<a name="line-422"></a><span class='hs-comment'>-- Potential problems:</span>
<a name="line-423"></a><span class='hs-comment'>-- 1b -&gt; formfailure (using formResult)</span>
<a name="line-424"></a><span class='hs-comment'>-- 2b -&gt; indicates the token was already used or something. Show a page</span>
<a name="line-425"></a><span class='hs-comment'>-- with options to log in, get saved password? Or just redirect to</span>
<a name="line-426"></a><span class='hs-comment'>-- Login page which has all of those options. Ok, do that with a</span>
<a name="line-427"></a><span class='hs-comment'>-- warning</span>
<a name="line-428"></a><span class='hs-comment'>-- 3b -&gt; Same deal as 2b</span>
<a name="line-429"></a><span class='hs-comment'>-- 4b -&gt; this should not ever fail ;) If it does? Redirect anyway? Makes me</span>
<a name="line-430"></a><span class='hs-comment'>-- think, what happens if storing the provisional user fails? Eh, internal</span>
<a name="line-431"></a><span class='hs-comment'>-- error page. Good enough.</span>
<a name="line-432"></a><span class='hs-comment'>--</span>
<a name="line-433"></a><span class='hs-comment'>-- This method is rather blithe in the belief that the priviliged methods</span>
<a name="line-434"></a><span class='hs-comment'>-- above ensure that a good token is truly "good".</span>
<a name="line-435"></a><span class='hs-definition'>postVerifyAccountR</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Yesod</span> <span class='hs-varid'>m</span>
<a name="line-436"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersist</span> <span class='hs-varid'>m</span>
<a name="line-437"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>YesodPersistBackend</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>~</span> <span class='hs-conid'>SqlBackend</span>
<a name="line-438"></a>                      <span class='hs-layout'>,</span><span class='hs-conid'>RenderMessage</span> <span class='hs-varid'>m</span> <span class='hs-conid'>FormMessage</span><span class='hs-layout'>)</span>
<a name="line-439"></a>                   <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HandlerT</span> <span class='hs-conid'>AuthSite</span> <span class='hs-layout'>(</span><span class='hs-conid'>HandlerT</span> <span class='hs-varid'>m</span> <span class='hs-conid'>IO</span><span class='hs-layout'>)</span> <span class='hs-conid'>Html</span>
<a name="line-440"></a><span class='hs-definition'>postVerifyAccountR</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-441"></a>    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-442"></a>        <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runFormPost</span> <span class='hs-layout'>(</span><span class='hs-varid'>renderDivs</span> <span class='hs-layout'>(</span><span class='hs-conid'>AuthToken</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>areq</span> <span class='hs-varid'>textField</span> <span class='hs-str'>""</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-443"></a>    <span class='hs-comment'>-- 1a</span>
<a name="line-444"></a>    <span class='hs-varid'>flip</span> <span class='hs-varid'>formResult</span> <span class='hs-varid'>res</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tok</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-445"></a>        <span class='hs-comment'>-- 2a/3a</span>
<a name="line-446"></a>        <span class='hs-comment'>-- Have to check the token and insert the user in the same</span>
<a name="line-447"></a>        <span class='hs-comment'>-- transaction, lest race conditions boggle the contraptions</span>
<a name="line-448"></a>        <span class='hs-varid'>mm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runDB</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sequence</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>upsertUser</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>checkToken</span> <span class='hs-varid'>tok</span>
<a name="line-449"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>mm</span> <span class='hs-keyword'>of</span>
<a name="line-450"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-451"></a>                <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>alertWarning</span> <span class='hs-str'>"Uh oh, your token appears to be invalid!"</span>
<a name="line-452"></a>                <span class='hs-varid'>redirectParent</span> <span class='hs-conid'>LoginR</span>
<a name="line-453"></a>            <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-454"></a>                <span class='hs-varid'>lift</span> <span class='hs-varop'>$</span> <span class='hs-varid'>alertSuccess</span> <span class='hs-str'>"You are all set! Log in to continue."</span>
<a name="line-455"></a>                <span class='hs-varid'>redirectParent</span> <span class='hs-conid'>LoginR</span>
<a name="line-456"></a>  <span class='hs-keyword'>where</span>
<a name="line-457"></a>    <span class='hs-varid'>upsertUser</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>VerifiedUser</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SqlPersistT</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Entity</span> <span class='hs-conid'>User</span><span class='hs-layout'>)</span>
<a name="line-458"></a>    <span class='hs-varid'>upsertUser</span> <span class='hs-conid'>VerifiedUser</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-459"></a>        <span class='hs-varid'>upsert</span> <span class='hs-layout'>(</span><span class='hs-conid'>User</span> <span class='hs-varid'>verifiedEmail</span> <span class='hs-varid'>verifiedDigest</span><span class='hs-layout'>)</span>
<a name="line-460"></a>               <span class='hs-keyglyph'>[</span><span class='hs-conid'>UserDigest</span> <span class='hs-varop'>=.</span> <span class='hs-varid'>verifiedDigest</span><span class='hs-keyglyph'>]</span>
<a name="line-461"></a>
<a name="line-462"></a><a name="redirectParent"></a><span class='hs-definition'>redirectParent</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-463"></a>    <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getRouteToParent</span>
<a name="line-464"></a>    <span class='hs-varid'>lift</span> <span class='hs-layout'>(</span><span class='hs-varid'>redirect</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre></body>
</html>
